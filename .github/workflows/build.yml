name: Build and Test CS2DJIT

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: Cache LuaJIT build
      uses: actions/cache@v4
      with:
        path: luajit/src/libluajit.a
        key: luajit-${{ runner.os }}-${{ hashFiles('luajit/**') }}
        restore-keys: |
          luajit-${{ runner.os }}-
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          gcc-multilib \
          g++-multilib \
          libc6-dev-i386
    
    - name: Build LuaJIT
      run: |
        cd luajit
        if [ ! -f src/libluajit.a ]; then
          make clean
          make BUILDMODE=static CC="gcc -m32" -j$(nproc)
        else
          echo "✅ Using cached LuaJIT build"
        fi
        cd ..
    
    - name: Build CS2DJIT
      run: |
        gcc -m32 -shared -fPIC \
          -O2 \
          -Wall -Wextra \
          -I./luajit/src \
          src/cs2djitbase.c \
          src/cs2djitmem.c \
          src/cs2djitlinux.c \
          ./luajit/src/libluajit.a \
          -o libcs2djit.so \
          -ldl -lpthread
    
    - name: Verify build
      run: |
        if [ ! -f libcs2djit.so ]; then
          echo "❌ libcs2djit.so not found!"
          exit 1
        fi
        echo "✅ libcs2djit.so built successfully"
        ls -lh libcs2djit.so
    
    - name: Check library properties
      run: |
        echo "=== File info ==="
        file libcs2djit.so
        
        echo -e "\n=== Library dependencies ==="
        ldd libcs2djit.so || true
        
        echo -e "\n=== Exported symbols (first 30) ==="
        nm -D libcs2djit.so | head -30
        
        echo -e "\n=== LuaJIT symbols check ==="
        if nm libcs2djit.so | grep -i "lua" | head -10; then
          echo "✅ Lua symbols found"
        else
          echo "⚠️  No Lua symbols detected"
        fi
    
    - name: Create build info
      run: |
        echo "Build Date: $(date)" > build_info.txt
        echo "Commit: ${{ github.sha }}" >> build_info.txt
        echo "Branch: ${{ github.ref_name }}" >> build_info.txt
        echo "File size: $(stat -c%s libcs2djit.so) bytes" >> build_info.txt
        cat build_info.txt
    
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: libcs2djit-linux-x86
        path: |
          libcs2djit.so
          build_info.txt
        retention-days: 30
    
    - name: Create Release
      if: contains(github.event.head_commit.message, '[release]')
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v${{ github.run_number }}
        name: Release v${{ github.run_number }}
        files: libcs2djit.so
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}