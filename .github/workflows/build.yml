name: Build and Release CS2DJIT

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    if: contains(github.event.head_commit.message, '[release]')
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v6
      with:
        submodules: recursive
    
    - name: Install build tools
      run: sudo apt update && sudo apt install -y gcc-multilib libc6-dev-i386
    
    - name: Build LuaJIT
      run: |
        cd luajit
        make BUILDMODE=static CC="gcc" CFLAGS="-m32 -fPIC -O2" -j$(nproc)
    
    - name: Build CS2DJIT
      run: |
        gcc -m32 -shared -fPIC -O2 -s \
          -I./luajit/src \
          src/cs2djitbase.c src/cs2djitmem.c src/cs2djitlinux.c \
          ./luajit/src/libluajit.a \
          -o libcs2djit.so \
          -ldl -lpthread
    
    - name: Create release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v${{ github.run_number }}
        files: libcs2djit.so
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}