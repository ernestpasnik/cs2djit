name: Build CS2DJIT

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    if: contains(github.event.head_commit.message, '[release]') || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: Install dependencies
      run: sudo apt update && sudo apt install -y gcc-multilib libc6-dev-i386
    
    - name: Build LuaJIT
      run: cd luajit && make HOST_CC="gcc -m32" CC="gcc -m32" BUILDMODE=static -j$(nproc)
    
    - name: Build CS2DJIT
      run: |
        gcc -m32 -shared -fPIC -O2 -s -Wall \
          -I./luajit/src \
          src/*.c \
          ./luajit/src/libluajit.a \
          -o libcs2djit.so \
          -ldl -lpthread
    
    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: v${{ github.run_number }}
        files: libcs2djit.so
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}